<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verify Payments (CSV / XLS / XLSX)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    padding: 40px;
  }
  .box {
    max-width: 700px;
    background: #fff;
    padding: 25px;
    margin: auto;
    border-radius: 8px;
    box-shadow: 0 10px 20px rgba(0,0,0,.1);
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin-top: 12px;
  }
  button {
    background: #0b3c5d;
    color: #fff;
    border: none;
    cursor: pointer;
  }
  pre {
    background: #eee;
    padding: 10px;
    margin-top: 15px;
    max-height: 300px;
    overflow: auto;
  }
</style>
</head>

<body>

<div class="box">
  <h2>Payment Verification</h2>
  <input type="file" id="fileInput" accept=".csv,.xls,.xlsx">
  <button onclick="processFile()">Verify</button>
  <pre id="result"></pre>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
async function processFile() {

  console.clear();
  const file = document.getElementById("fileInput").files[0];
  const resultBox = document.getElementById("result");

  if (!file) {
    alert("Select file");
    return;
  }

  const reader = new FileReader();

  reader.onload = async (e) => {
    try {
      let payments = [];

      /* =================== EXCEL =================== */
      if (!file.name.toLowerCase().endsWith(".csv")) {

        const wb = XLSX.read(e.target.result, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];

        // Read as 2D array (IMPORTANT)
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

        console.log("ALL ROWS");
        console.table(rows);

        // üîç FIND HEADER ROW
        let headerRowIndex = -1;
        let headers = [];

        for (let i = 0; i < rows.length; i++) {
          const rowText = rows[i].join(" ").toLowerCase();
          if (rowText.includes("deposit") && rowText.includes("remark")) {
            headerRowIndex = i;
            headers = rows[i];
            console.log("‚úî Header row found at:", i + 1);
            break;
          }
        }

        if (headerRowIndex === -1) {
          alert("Transaction table not found");
          return;
        }

        const depositIndex = headers.findIndex(h =>
          h.toLowerCase().includes("deposit")
        );

        const remarksIndex = headers.findIndex(h =>
          h.toLowerCase().includes("remark")
        );

        console.log("Deposit index:", depositIndex);
        console.log("Remarks index:", remarksIndex);

        // üìä DATA ROWS
        for (let i = headerRowIndex + 1; i < rows.length; i++) {

          const row = rows[i];
          const deposit = Number(String(row[depositIndex]).replace(/,/g, ""));
          const remarks = row[remarksIndex];

          if (!deposit || deposit <= 0) continue;

          const match = remarks?.match(/UPI\/(?:CR|DR)\/(\d+)\//);
          if (!match) continue;

          payments.push({
            transaction_id: match[1],
            amount: deposit
          });
        }
      }

      /* =================== CSV =================== */
      else {
        const lines = e.target.result.split("\n").map(l => l.trim()).filter(Boolean);

        let headerIndex = -1;
        let headers = [];

        for (let i = 0; i < lines.length; i++) {
          if (lines[i].toLowerCase().includes("deposit") &&
              lines[i].toLowerCase().includes("remark")) {
            headerIndex = i;
            headers = lines[i].split(",");
            break;
          }
        }

        const dIndex = headers.findIndex(h => h.toLowerCase().includes("deposit"));
        const rIndex = headers.findIndex(h => h.toLowerCase().includes("remark"));

        for (let i = headerIndex + 1; i < lines.length; i++) {
          const cols = lines[i].split(",").map(v => v.replace(/"/g, "").trim());
          const deposit = Number(cols[dIndex]);
          const remarks = cols[rIndex];

          if (!deposit || deposit <= 0) continue;
          const match = remarks?.match(/UPI\/(?:CR|DR)\/(\d+)\//);
          if (!match) continue;

          payments.push({
            transaction_id: match[1],
            amount: deposit
          });
        }
      }

      console.table(payments);

      if (!payments.length) {
        alert("No valid deposits found");
        return;
      }

      const res = await fetch(
        "https://threads26-2-fdem.onrender.com/api/admin/verify-payments",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ payments })
        }
      );

      const data = await res.json();
      resultBox.textContent = JSON.stringify(data, null, 2);

    } catch (err) {
      console.error(err);
      resultBox.textContent = err.message;
    }
  };

  file.name.endsWith(".csv")
    ? reader.readAsText(file)
    : reader.readAsArrayBuffer(file);
}
</script>

</body>
</html>
