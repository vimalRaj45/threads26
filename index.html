<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreadCSE'26 - OTP Registration Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .otp-group {
            display: flex;
            gap: 10px;
        }
        
        .otp-group input {
            flex: 1;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.3);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            min-width: 120px;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }
        
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .response-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .response-area h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        pre {
            background: #1e1e2f;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .timer {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .config-panel {
            background: #f0f4f8;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px dashed #667eea;
        }
        
        .config-panel h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .token-display {
            background: #1e1e2f;
            color: #10b981;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            margin-top: 10px;
            word-break: break-all;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .step-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            transform: translateY(-50%);
            z-index: 1;
        }
        
        .step {
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 14px;
            color: #666;
            border: 2px solid #e0e0e0;
            position: relative;
            z-index: 2;
        }
        
        .step.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .step.completed {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîê ThreadCSE'26 Registration Test</h1>
            <p class="subtitle">OTP Verification First, Then Register with Token</p>
            
            <!-- Configuration Panel -->
            <div class="config-panel">
                <h4>‚öôÔ∏è Configuration</h4>
                <div class="form-group">
                    <label>API Key (from .env)</label>
                    <input type="text" id="apiKey" value="7f8e3a1b9c4d2e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f" placeholder="Enter API key">
                </div>
                <div class="form-group">
                    <label>Server URL</label>
                    <input type="text" id="serverUrl" value="http://localhost:3000" placeholder="http://localhost:3000">
                </div>
            </div>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1Indicator">1. Send OTP</div>
                <div class="step" id="step2Indicator">2. Verify OTP</div>
                <div class="step" id="step3Indicator">3. Register</div>
            </div>
            
            <!-- Status Messages -->
            <div id="status" class="status" style="display: none;"></div>
            
            <!-- Step 1: Send OTP Form -->
            <div id="step1">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="name" placeholder="John Doe" value="Test User">
                </div>
                
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="email" placeholder="test@example.com" value="test@example.com">
                </div>
                
                <div class="form-group">
                    <button class="btn btn-primary" id="sendOtpBtn" onclick="sendOTP()">
                        üìß Send OTP
                    </button>
                </div>
                
                <div id="otpTimer" class="timer" style="text-align: center; display: none;">
                    ‚è±Ô∏è Resend OTP in <span id="countdown">60</span> seconds
                </div>
            </div>
            
            <!-- Step 2: Verify OTP Form (Hidden initially) -->
            <div id="step2" class="hidden">
                <div class="form-group">
                    <label>Email (verified)</label>
                    <input type="email" id="verifiedEmail" readonly disabled>
                </div>
                
                <div class="form-group">
                    <label>Enter OTP</label>
                    <div class="otp-group">
                        <input type="text" id="otp" placeholder="123456" maxlength="6">
                        <button class="btn btn-secondary" id="verifyOtpBtn" onclick="verifyOTP()">
                            Verify OTP
                        </button>
                    </div>
                </div>
                
                <!-- Verification Token (hidden) -->
                <div id="tokenDisplay" class="token-display hidden"></div>
            </div>
            
            <!-- Step 3: Registration Form (Hidden initially) -->
            <div id="step3" class="hidden">
                <h4 style="margin-bottom: 15px;">Complete Registration</h4>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="regEmail" readonly disabled>
                </div>
                
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="regName" readonly disabled>
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" id="phone" value="9876543210">
                    </div>
                    
                    <div class="form-group">
                        <label>College</label>
                        <input type="text" id="college" value="Test College">
                    </div>
                </div>
                
                <div class="row">
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="department" value="CSE">
                    </div>
                    
                    <div class="form-group">
                        <label>Year</label>
                        <select id="year">
                            <option value="1">1st Year</option>
                            <option value="2" selected>2nd Year</option>
                            <option value="3">3rd Year</option>
                            <option value="4">4th Year</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Workshop Selections (comma-separated IDs)</label>
                    <input type="text" id="workshops" value="1,2" placeholder="e.g., 1,2">
                </div>
                
                <div class="form-group">
                    <label>Event Selections (comma-separated IDs)</label>
                    <input type="text" id="events" value="3,4" placeholder="e.g., 3,4">
                </div>
                
                <button class="btn btn-success" id="registerBtn" onclick="register()">
                    ‚úÖ Complete Registration
                </button>
            </div>
            
            <!-- API Response Display -->
            <div class="response-area">
                <h3>üì° API Response</h3>
                <pre id="response">Click buttons above to see responses...</pre>
            </div>
            
            <!-- Test Info -->
            <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 14px;">
                <strong>üìã Test Flow:</strong>
                <ol style="margin-top: 8px; margin-left: 20px; color: #0c5460;">
                    <li><strong>Send OTP</strong> - Get OTP on email (check console for dev OTP)</li>
                    <li><strong>Verify OTP</strong> - Get verification token (valid 15 min)</li>
                    <li><strong>Register</strong> - Use token to complete registration</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // State variables
        let countdownInterval;
        let verificationToken = '';
        let currentEmail = '';
        let currentName = '';
        
        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Start countdown timer for OTP resend
        function startCountdown(seconds) {
            const timerDiv = document.getElementById('otpTimer');
            const countdownSpan = document.getElementById('countdown');
            const sendBtn = document.getElementById('sendOtpBtn');
            
            timerDiv.style.display = 'block';
            sendBtn.disabled = true;
            
            countdownInterval = setInterval(() => {
                seconds--;
                countdownSpan.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    timerDiv.style.display = 'none';
                    sendBtn.disabled = false;
                }
            }, 1000);
        }
        
        // Get headers with API key
        function getHeaders() {
            const apiKey = document.getElementById('apiKey').value;
            return {
                'Content-Type': 'application/json',
                'x-api-key': apiKey
            };
        }
        
        // Get server URL
        function getServerUrl() {
            return document.getElementById('serverUrl').value;
        }
        
        // Update step indicators
        function updateSteps(activeStep) {
            const step1 = document.getElementById('step1Indicator');
            const step2 = document.getElementById('step2Indicator');
            const step3 = document.getElementById('step3Indicator');
            
            step1.className = 'step';
            step2.className = 'step';
            step3.className = 'step';
            
            if (activeStep >= 1) step1.className = 'step completed';
            if (activeStep >= 2) step2.className = 'step completed';
            if (activeStep >= 3) step3.className = 'step completed';
            
            if (activeStep === 1) step1.className = 'step active';
            if (activeStep === 2) step2.className = 'step active';
            if (activeStep === 3) step3.className = 'step active';
        }
        
        // Show/hide steps
        function showStep(step) {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            
            if (step === 1) {
                document.getElementById('step1').classList.remove('hidden');
                updateSteps(1);
            } else if (step === 2) {
                document.getElementById('step2').classList.remove('hidden');
                updateSteps(2);
            } else if (step === 3) {
                document.getElementById('step3').classList.remove('hidden');
                updateSteps(3);
            }
        }
        
        // Step 1: Send OTP
        async function sendOTP() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            
            if (!name || !email) {
                showStatus('Please enter name and email', 'error');
                return;
            }
            
            // Store for later use
            currentName = name;
            currentEmail = email;
            
            try {
                const response = await fetch(getServerUrl() + '/api/send-otp', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ name, email })
                });
                
                const data = await response.json();
                document.getElementById('response').textContent = 
                    JSON.stringify(data, null, 2);
                
                if (data.success) {
                    showStatus('‚úÖ OTP sent successfully! Check email.', 'success');
                    
                    // Pre-fill step 2
                    document.getElementById('verifiedEmail').value = email;
                    
                    // Show step 2
                    showStep(2);
                    
                    // Start countdown
                    startCountdown(60);
                    
                    // FOR TESTING: Log OTP to console
                    if (data.otp) {
                        console.log('%cüîë TEST OTP: ' + data.otp, 'font-size: 16px; background: #000; color: #0f0; padding: 5px;');
                        console.log('üìã Copy this OTP to verify:', data.otp);
                        showStatus(`üìã Dev OTP: ${data.otp} (check console too)`, 'info');
                    }
                } else {
                    showStatus('‚ùå ' + (data.message || data.error || 'Failed'), 'error');
                }
            } catch (error) {
                document.getElementById('response').textContent = 
                    'Error: ' + error.message;
                showStatus('‚ùå Failed to connect to server', 'error');
            }
        }
        
       // Step 2: Verify OTP and get token
async function verifyOTP() {
    const email = document.getElementById('verifiedEmail').value;
    const otp = document.getElementById('otp').value;
    
    if (!otp || otp.length !== 6) {
        showStatus('Please enter 6-digit OTP', 'error');
        return;
    }
    
    // Debug: Log what we're sending
    console.log('Sending verification request:', {
        email: email,
        otp: otp.toString()  // Ensure it's a string
    });
    
    try {
        const response = await fetch(getServerUrl() + '/api/verify-otp', {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({ 
                email: email, 
                otp: otp.toString()  // Send as string
            })
        });
        
        const data = await response.json();
        document.getElementById('response').textContent = 
            JSON.stringify(data, null, 2);
        
        if (data.success) {
            verificationToken = data.verification_token;
            
            showStatus('‚úÖ OTP verified! Get token', 'success');
            
            // Show token
            const tokenDiv = document.getElementById('tokenDisplay');
            tokenDiv.classList.remove('hidden');
            tokenDiv.textContent = 'üîë Token: ' + verificationToken;
            
            // Pre-fill registration form
            document.getElementById('regEmail').value = email;
            document.getElementById('regName').value = currentName;
            
            // Show step 3 after 1 second
            setTimeout(() => {
                showStep(3);
            }, 1000);
            
        } else {
            showStatus('‚ùå ' + (data.message || data.error || 'Verification failed'), 'error');
            
            // Log detailed error
            console.error('Verification failed:', data);
        }
    } catch (error) {
        document.getElementById('response').textContent = 
            'Error: ' + error.message;
        showStatus('‚ùå Verification failed', 'error');
        console.error('Fetch error:', error);
    }
}
        
        // Step 3: Complete Registration with Token
        async function register() {
            if (!verificationToken) {
                showStatus('No verification token. Please verify OTP first.', 'error');
                showStep(2);
                return;
            }
            
            const email = document.getElementById('regEmail').value;
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('phone').value;
            const college = document.getElementById('college').value;
            const dept = document.getElementById('department').value;
            const year = document.getElementById('year').value;
            
            // Parse selections
            const workshopSelections = document.getElementById('workshops').value
                .split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            const eventSelections = document.getElementById('events').value
                .split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            
            // Validate
            if (workshopSelections.length === 0 && eventSelections.length === 0) {
                showStatus('Select at least one event or workshop', 'error');
                return;
            }
            
            const registrationData = {
                full_name: name,
                email: email,
                phone: phone,
                college_name: college,
                department: dept,
                year_of_study: parseInt(year),
                workshop_selections: workshopSelections,
                event_selections: eventSelections,
                verification_token: verificationToken,  // Using token, not OTP
                gender: 'Male',
                city: 'Test City',
                state: 'Test State',
                accommodation_required: false
            };
            
            try {
                const response = await fetch(getServerUrl() + '/api/register', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(registrationData)
                });
                
                const data = await response.json();
                document.getElementById('response').textContent = 
                    JSON.stringify(data, null, 2);
                
                if (data.success) {
                    showStatus('‚úÖ Registration successful!', 'success');
                    updateSteps(3);
                    
                    // Clear token
                    verificationToken = '';
                } else {
                    showStatus('‚ùå ' + (data.details || data.error || 'Registration failed'), 'error');
                }
            } catch (error) {
                document.getElementById('response').textContent = 
                    'Error: ' + error.message;
                showStatus('‚ùå Registration failed', 'error');
            }
        }
        
        // Helper to clear timer on page unload
        window.addEventListener('beforeunload', function() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
        });
    </script>
</body>
</html>
