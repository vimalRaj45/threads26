<!DOCTYPE html>
<html>
<head>
    <title>Event Attendance Portal</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<div id="portal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 id="eventTitle">Event Attendance Portal</h1>
        <button onclick="window.close()">Close Portal</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px; margin-top:20px;">

        <!-- LEFT -->
        <div>
            <h3>Quick Actions</h3>

            <div style="background:#f5f5f5; padding:15px; border-radius:5px;">
                <h4>QR Code Scanner</h4>
                <div id="reader" style="width:100%;"></div>
                <div style="margin-top:10px;">
                    <button onclick="startScanner()">Start Scanner</button>
                    <button onclick="stopScanner()">Stop Scanner</button>
                </div>
                <div id="scanResult" style="margin-top:10px;"></div>
            </div>

            <div style="margin-top:20px; background:#f5f5f5; padding:15px; border-radius:5px;">
                <h4>Quick Search</h4>
                <input id="quickSearch" placeholder="Enter Registration ID or Name"
                       style="width:100%; padding:8px; margin-bottom:10px;">
                <button onclick="quickSearch()">Search & Mark</button>
                <div id="quickResult"></div>
            </div>

            <div style="margin-top:20px; background:#f5f5f5; padding:15px; border-radius:5px;">
                <h4>Attendance Stats</h4>
                <p>Total Registered: <span id="totalRegistered">0</span></p>
                <p>Present: <span id="presentCount">0</span></p>
                <p>Absent: <span id="absentCount">0</span></p>
                <p>Attendance %: <span id="attendancePercent">0%</span></p>
            </div>
        </div>

        <!-- RIGHT -->
        <div>
            <h3>All Registrations</h3>

            <input id="searchBox" placeholder="Search..." style="width:70%; padding:8px;" onkeyup="filterRegistrations()">
            <button onclick="refreshRegistrations()">Refresh</button>
            <button onclick="markAllPresent()">Mark All Present</button>

            <div id="registrationsContainer" style="margin-top:15px;"></div>
        </div>
    </div>
</div>

<script>
const BASE_URL = 'https://threads26-1-dtnm.onrender.com';
let token = localStorage.getItem('coordinatorToken');
let eventId = localStorage.getItem('currentEventId');
let eventName = localStorage.getItem('currentEventName');

let allRegistrations = [];
let html5QrCode;
let scanning = false;

/* ---------------- INIT ---------------- */
window.onload = () => {
    if (!token || !eventId) {
        alert('Login required');
        window.close();
        return;
    }
    document.getElementById('eventTitle').textContent =
        `${eventName} - Attendance Portal`;
    loadEventRegistrations();
    startScanner();
};

/* ---------------- SCANNER (FIXED) ---------------- */
function startScanner() {
    if (scanning) return;

    html5QrCode = new Html5Qrcode("reader");
    scanning = true;

    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        () => {}
    ).catch(() => scanning = false);
}

function stopScanner() {
    if (html5QrCode && scanning) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            scanning = false;
        });
    }
}

async function onScanSuccess(decodedText) {
    stopScanner();

    const scanDiv = document.getElementById('scanResult');
    scanDiv.innerHTML = ''; // clear previous logs

    // Display raw QR content
    const rawP = document.createElement('p');
    rawP.innerHTML = `<b>üì∏ QR Scanned:</b> <code>${decodedText}</code>`;
    scanDiv.appendChild(rawP);

    // Split multiple IDs
    const scannedIds = decodedText
        .split(/[\n, ]+/)
        .map(id => id.trim())
        .filter(Boolean);

    const parsedP = document.createElement('p');
    parsedP.innerHTML = `<b>üîπ Parsed IDs:</b> ${scannedIds.join(', ')}`;
    scanDiv.appendChild(parsedP);

    // Filter for current event
    const validIds = scannedIds.filter(id => id.endsWith(eventId));
    const invalidIds = scannedIds.filter(id => !id.endsWith(eventId));

    const validP = document.createElement('p');
    validP.innerHTML = `<b>‚úÖ Valid IDs for this event:</b> ${validIds.join(', ') || 'None'}`;
    scanDiv.appendChild(validP);

    const invalidP = document.createElement('p');
    invalidP.innerHTML = `<b>‚ùå Invalid IDs:</b> ${invalidIds.join(', ') || 'None'}`;
    scanDiv.appendChild(invalidP);

    if (validIds.length === 0) {
        const errP = document.createElement('p');
        errP.style.color = 'red';
        errP.textContent = '‚ùå No valid registrations for this event';
        scanDiv.appendChild(errP);
        setTimeout(startScanner, 1500);
        return;
    }

    try {
        for (let id of validIds) {
            const statusP = document.createElement('p');
            statusP.innerHTML = `üì° Sending attendance request for <b>${id}</b>...`;
            scanDiv.appendChild(statusP);

            const res = await fetch(`${BASE_URL}/api/scan-attendance`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ registration_id: id })
            });
            const data = await res.json();

            const respP = document.createElement('p');
            if (data.success) {
                respP.style.color = 'green';
                respP.innerHTML = `‚úÖ ${id} - ${data.message}`;
                // update local list
                const r = allRegistrations.find(x => x.registration_unique_id === id);
                if (r) r.attendance_status = 'ATTENDED';
            } else {
                respP.style.color = 'red';
                respP.innerHTML = `‚ùå ${id} - ${data.message}`;
            }
            scanDiv.appendChild(respP);
        }

        updateStats();
        displayRegistrations(allRegistrations);

        // Auto-clear after delay
        setTimeout(() => {
            scanDiv.innerHTML = '';
            startScanner();
        }, 4000);

    } catch (err) {
        const errP = document.createElement('p');
        errP.style.color = 'red';
        errP.textContent = `‚ùå Network error: ${err}`;
        scanDiv.appendChild(errP);
        startScanner();
    }
}


/* ---------------- DATA ---------------- */
async function loadEventRegistrations() {
    const res = await fetch(
        `${BASE_URL}/api/admin/registrations?event_id=${eventId}`,
        { headers: { 'x-admin-token': token } }
    );
    allRegistrations = await res.json();
    displayRegistrations(allRegistrations);
    updateStats();
}

function displayRegistrations(list) {
    let html = `<table border="1" cellpadding="8" width="100%">
    <tr><th>Name</th><th>ID</th><th>College</th><th>Status</th><th>Action</th></tr>`;
    list.forEach(r => {
        html += `<tr>
            <td>${r.full_name}</td>
            <td>${r.registration_unique_id}</td>
            <td>${r.college_name}</td>
            <td>${r.attendance_status}</td>
            <td>
                <button onclick="toggleAttendance('${r.registration_unique_id}','${r.attendance_status}')">
                    ${r.attendance_status === 'ATTENDED' ? 'Mark Absent' : 'Mark Present'}
                </button>
            </td>
        </tr>`;
    });
    html += '</table>';
    document.getElementById('registrationsContainer').innerHTML = html;
}

function updateStats() {
    const total = allRegistrations.length;
    const present = allRegistrations.filter(r => r.attendance_status === 'ATTENDED').length;
    document.getElementById('totalRegistered').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = total - present;
    document.getElementById('attendancePercent').textContent =
        total ? ((present / total) * 100).toFixed(1) + '%' : '0%';
}

/* ---------------- KEEP YOUR EXISTING FUNCTIONS ---------------- */
function filterRegistrations(){displayRegistrations(allRegistrations);}
function refreshRegistrations(){loadEventRegistrations();}
function quickSearch(){}
function markAllPresent(){}
function toggleAttendance(){}
</script>

</body>
</html>
