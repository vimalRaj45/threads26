<!DOCTYPE html>
<html>
<head>
    <title>Event Attendance Portal</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<div id="portal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 id="eventTitle">Event Attendance Portal</h1>
        <button onclick="window.close()">Close Portal</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px; margin-top:20px;">

        <!-- LEFT -->
        <div>
            <h3>Quick Actions</h3>

            <div style="background:#f5f5f5; padding:15px; border-radius:5px;">
                <h4>QR Code Scanner</h4>
                <div id="reader" style="width:100%;"></div>
                <div style="margin-top:10px;">
                    <button onclick="startScanner()">Start Scanner</button>
                    <button onclick="stopScanner()">Stop Scanner</button>
                </div>
                <div id="scanResult" style="margin-top:10px;"></div>
            </div>

            <div style="margin-top:20px; background:#f5f5f5; padding:15px; border-radius:5px;">
                <h4>Quick Search</h4>
                <input id="quickSearch" placeholder="Enter Registration ID or Name"
                       style="width:100%; padding:8px; margin-bottom:10px;">
                <button onclick="quickSearch()">Search & Mark</button>
                <div id="quickResult"></div>
            </div>

            <div style="margin-top:20px; background:#f5f5f5; padding:15px; border-radius:5px;">
                <h4>Attendance Stats</h4>
                <p>Total Registered: <span id="totalRegistered">0</span></p>
                <p>Present: <span id="presentCount">0</span></p>
                <p>Absent: <span id="absentCount">0</span></p>
                <p>Attendance %: <span id="attendancePercent">0%</span></p>
            </div>
        </div>

        <!-- RIGHT -->
        <div>
            <h3>All Registrations</h3>

            <input id="searchBox" placeholder="Search..." style="width:70%; padding:8px;" onkeyup="filterRegistrations()">
            <button onclick="refreshRegistrations()">Refresh</button>
            <button onclick="markAllPresent()">Mark All Present</button>

            <div id="registrationsContainer" style="margin-top:15px;"></div>
        </div>
    </div>
</div>

<script>
const BASE_URL = 'https://threads26-1-dtnm.onrender.com';
let token = localStorage.getItem('coordinatorToken');
let eventId = localStorage.getItem('currentEventId');
let eventName = localStorage.getItem('currentEventName');

let allRegistrations = [];
let html5QrCode;
let scanning = false;

/* ---------------- INIT ---------------- */
window.onload = () => {
    if (!token || !eventId) {
        alert('Login required');
        window.close();
        return;
    }
    document.getElementById('eventTitle').textContent =
        `${eventName} - Attendance Portal`;
    loadEventRegistrations();
    startScanner();
};

/* ---------------- SCANNER (FIXED) ---------------- */
function startScanner() {
    if (scanning) return;

    html5QrCode = new Html5Qrcode("reader");
    scanning = true;

    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        () => {}
    ).catch(() => scanning = false);
}

function stopScanner() {
    if (html5QrCode && scanning) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            scanning = false;
        });
    }
}

async function onScanSuccess(decodedText) {
    stopScanner();

    // ‚úÖ SHOW RAW QR CONTENT
    console.log("üì∏ QR SCANNED:", decodedText);

    document.getElementById('scanResult').innerHTML = `
        <p style="color:#333;">
            <b>Scanned QR Content:</b><br>
            <code style="word-break:break-all;">${decodedText}</code>
        </p>
        <p style="color:blue;">Processing attendance...</p>
    `;

    // Split multiple IDs (comma / newline / space)
    const scannedIds = decodedText
        .split(/[\n, ]+/)
        .map(id => id.trim())
        .filter(Boolean);

    console.log("‚úÖ Parsed IDs:", scannedIds);

    // Allow only current event IDs
    const validIds = scannedIds.filter(id => id.endsWith(eventId));
    const invalidIds = scannedIds.filter(id => !id.endsWith(eventId));

    console.log("üü¢ Valid IDs:", validIds);
    console.log("üî¥ Invalid IDs:", invalidIds);

    if (validIds.length === 0) {
        document.getElementById('scanResult').innerHTML +=
            `<p style="color:red;">‚ùå No valid registrations for this event</p>`;
        setTimeout(startScanner, 1500);
        return;
    }

    try {
        const res = await fetch(`${BASE_URL}/api/admin/attendance`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-admin-token': token
            },
            body: JSON.stringify({
                registration_ids: validIds,
                attendance_status: 'ATTENDED'
            })
        });

        const data = await res.json();

        console.log("üì° API Response:", data);

        if (!res.ok) {
            document.getElementById('scanResult').innerHTML +=
                `<p style="color:red;">‚ùå ${data.error}</p>`;
            startScanner();
            return;
        }

        // Update UI state
        validIds.forEach(id => {
            const r = allRegistrations.find(x =>
                x.registration_unique_id === id
            );
            if (r) r.attendance_status = 'ATTENDED';
        });

        document.getElementById('scanResult').innerHTML += `
            <p style="color:green;">‚úÖ Attendance marked successfully</p>
        `;

        updateStats();
        displayRegistrations(allRegistrations);

        setTimeout(() => {
            document.getElementById('scanResult').innerHTML = '';
            startScanner();
        }, 1500);

    } catch (err) {
        console.error("‚ùå Network Error:", err);
        document.getElementById('scanResult').innerHTML +=
            `<p style="color:red;">‚ùå Network error</p>`;
        startScanner();
    }
}

/* ---------------- DATA ---------------- */
async function loadEventRegistrations() {
    const res = await fetch(
        `${BASE_URL}/api/admin/registrations?event_id=${eventId}`,
        { headers: { 'x-admin-token': token } }
    );
    allRegistrations = await res.json();
    displayRegistrations(allRegistrations);
    updateStats();
}

function displayRegistrations(list) {
    let html = `<table border="1" cellpadding="8" width="100%">
    <tr><th>Name</th><th>ID</th><th>College</th><th>Status</th><th>Action</th></tr>`;
    list.forEach(r => {
        html += `<tr>
            <td>${r.full_name}</td>
            <td>${r.registration_unique_id}</td>
            <td>${r.college_name}</td>
            <td>${r.attendance_status}</td>
            <td>
                <button onclick="toggleAttendance('${r.registration_unique_id}','${r.attendance_status}')">
                    ${r.attendance_status === 'ATTENDED' ? 'Mark Absent' : 'Mark Present'}
                </button>
            </td>
        </tr>`;
    });
    html += '</table>';
    document.getElementById('registrationsContainer').innerHTML = html;
}

function updateStats() {
    const total = allRegistrations.length;
    const present = allRegistrations.filter(r => r.attendance_status === 'ATTENDED').length;
    document.getElementById('totalRegistered').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = total - present;
    document.getElementById('attendancePercent').textContent =
        total ? ((present / total) * 100).toFixed(1) + '%' : '0%';
}

/* ---------------- KEEP YOUR EXISTING FUNCTIONS ---------------- */
function filterRegistrations(){displayRegistrations(allRegistrations);}
function refreshRegistrations(){loadEventRegistrations();}
function quickSearch(){}
function markAllPresent(){}
function toggleAttendance(){}
</script>

</body>
</html>
