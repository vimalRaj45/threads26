<!DOCTYPE html>
<html>
<head>
    <title>Event Attendance Portal</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<div id="portal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 id="eventTitle">Event Attendance Portal</h1>
        <button onclick="window.close()">Close Portal</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px; margin-top:20px;">

        <!-- LEFT -->
        <div>
            <h3>Quick Actions</h3>

            <div style="background:#f5f5f5; padding:15px; border-radius:5px;">
                <h4>QR Code Scanner</h4>
                <div id="reader" style="width:100%;"></div>
                <div style="margin-top:10px;">
                    <button onclick="startScanner()">Start Scanner</button>
                    <button onclick="stopScanner()">Stop Scanner</button>
                </div>
                <div id="scanResult" style="margin-top:10px;"></div>
            </div>

            <div style="margin-top:20px; background:#f5f5f5; padding:15px; border-radius:5px;">
                <h4>Attendance Stats</h4>
                <p>Total Registered: <span id="totalRegistered">0</span></p>
                <p>Present: <span id="presentCount">0</span></p>
                <p>Absent: <span id="absentCount">0</span></p>
                <p>Attendance %: <span id="attendancePercent">0%</span></p>
            </div>
        </div>

        <!-- RIGHT -->
        <div>
            <h3>All Registrations</h3>

            <input
                id="searchBox"
                placeholder="Search by Name / ID / College..."
                style="width:70%; padding:8px;"
                onkeyup="filterRegistrations()"
            >
            <button onclick="refreshRegistrations()">Refresh</button>

            <div id="registrationsContainer" style="margin-top:15px;"></div>
        </div>
    </div>
</div>

<script>
const BASE_URL = 'https://threads26-1-dtnm.onrender.com';
let token = localStorage.getItem('coordinatorToken');
let eventId = localStorage.getItem('currentEventId');
let eventName = localStorage.getItem('currentEventName');

let allRegistrations = [];
let html5QrCode;
let scanning = false;

/* ---------------- INIT ---------------- */
window.onload = () => {
    if (!token || !eventId) {
        alert('Login required');
        window.close();
        return;
    }
    document.getElementById('eventTitle').textContent =
        `${eventName} - Attendance Portal`;
    loadEventRegistrations();
    startScanner();
};

/* ---------------- SCANNER ---------------- */
function startScanner() {
    if (scanning) return;

    html5QrCode = new Html5Qrcode("reader");
    scanning = true;

    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        () => {}
    ).catch(() => scanning = false);
}

function stopScanner() {
    if (html5QrCode && scanning) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            scanning = false;
        });
    }
}

async function onScanSuccess(decodedText) {
    stopScanner();
    const scanDiv = document.getElementById('scanResult');
    scanDiv.innerHTML = '';

    let scannedIds = [];

    try {
        const qrData = JSON.parse(decodedText);
        scannedIds = qrData.registration_ids || [];
    } catch {
        scannedIds = decodedText.split(/[\n, ]+/).map(x => x.trim()).filter(Boolean);
    }

    const validIds = scannedIds.filter(id => id.includes(eventId));

    if (validIds.length === 0) {
        scanDiv.innerHTML = '<p style="color:red">❌ Invalid QR</p>';
        setTimeout(startScanner, 1500);
        return;
    }

    for (let id of validIds) {
        const res = await fetch(`${BASE_URL}/api/scan-attendance`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ registration_id: id })
        });

        const data = await res.json();
        const p = document.createElement('p');

        if (data.success) {
            p.style.color = 'green';
            p.textContent = `✅ ${id} - ${data.message}`;
            const r = allRegistrations.find(x => x.registration_unique_id === id);
            if (r) r.attendance_status = 'ATTENDED';
        } else {
            p.style.color = 'red';
            p.textContent = `❌ ${id} - ${data.message}`;
        }

        scanDiv.appendChild(p);
    }

    updateStats();
    filterRegistrations();

    setTimeout(() => {
        scanDiv.innerHTML = '';
        startScanner();
    }, 3000);
}

/* ---------------- DATA ---------------- */
async function loadEventRegistrations() {
    const res = await fetch(
        `${BASE_URL}/api/admin/registrations?event_id=${eventId}`,
        { headers: { 'x-admin-token': token } }
    );
    allRegistrations = await res.json();
    displayRegistrations(allRegistrations);
    updateStats();
}

function displayRegistrations(list) {
    let html = `<table border="1" cellpadding="8" width="100%">
        <tr>
            <th>Name</th>
            <th>ID</th>
            <th>College</th>
            <th>Status</th>
            <th>Admin Verified</th>
        </tr>`;

    list.forEach(r => {
        html += `<tr>
            <td>${r.full_name}</td>
            <td>${r.registration_unique_id}</td>
            <td>${r.college_name}</td>
            <td>${r.attendance_status}</td>
            <td>${r.verification_status}</td>
        </tr>`;
    });

    html += '</table>';
    document.getElementById('registrationsContainer').innerHTML = html;
}

function updateStats() {
    const total = allRegistrations.length;
    const present = allRegistrations.filter(r => r.attendance_status === 'ATTENDED').length;
    document.getElementById('totalRegistered').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = total - present;
    document.getElementById('attendancePercent').textContent =
        total ? ((present / total) * 100).toFixed(1) + '%' : '0%';
}

/* ---------------- SEARCH (ADDED) ---------------- */
function filterRegistrations() {
    const q = document.getElementById('searchBox').value.toLowerCase().trim();

    if (!q) {
        displayRegistrations(allRegistrations);
        return;
    }

    const filtered = allRegistrations.filter(r =>
        (r.full_name && r.full_name.toLowerCase().includes(q)) ||
        (r.registration_unique_id && r.registration_unique_id.toLowerCase().includes(q)) ||
        (r.college_name && r.college_name.toLowerCase().includes(q))
    );

    displayRegistrations(filtered);
}

/* ---------------- UTIL ---------------- */
function refreshRegistrations() {
    loadEventRegistrations();
}
</script>

</body>
</html>
