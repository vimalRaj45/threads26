<!DOCTYPE html>
<html>
<head>
    <title>Event Attendance Portal</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }
        .tab-button.active {
            background: #4CAF50;
            color: white;
        }
        .manual-input-group {
            margin: 15px 0;
        }
        .manual-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .manual-input-group input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        .search-result-item.selected {
            background-color: #e3f2fd;
        }
    </style>
</head>
<body>

<div id="portal">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 id="eventTitle">Event Attendance Portal</h1>
        <button onclick="window.close()">Close Portal</button>
    </div>

    <!-- Tab Navigation -->
    <div style="margin: 20px 0;">
        <button class="tab-button active" onclick="switchTab('qr')">QR Scanner</button>
        <button class="tab-button" onclick="switchTab('manual')">Manual Attendance</button>
        <button class="tab-button" onclick="switchTab('stats')">Statistics</button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px; margin-top:20px;">

        <!-- LEFT SIDE -->
        <div>
            <!-- QR Scanner Tab -->
            <div id="qr-tab" class="tab-content active">
                <div style="background:#f5f5f5; padding:15px; border-radius:5px;">
                    <h3>QR Code Scanner</h3>
                    <small style="color:#666;">Scan QR codes from Threads26 registration emails/confirmation.</small>
                    <div id="reader" style="width:100%;"></div>
                    <div style="margin-top:10px;">
                        <button onclick="startScanner()">Start Scanner</button>
                        <button onclick="stopScanner()">Stop Scanner</button>
                    </div>
                    <div id="scanResult" style="margin-top:10px;"></div>
                </div>
            </div>

            <!-- Manual Attendance Tab -->
            <div id="manual-tab" class="tab-content">
                <div style="background:#f5f5f5; padding:15px; border-radius:5px;">
                    <h3>Manual Attendance Entry</h3>
                    <small style="color:#666;">Use this when QR code cannot be scanned.</small>
                    
                    <!-- Participant Search -->
                    <div class="manual-input-group">
                        <label>Search Participant:</label>
                        <input 
                            type="text" 
                            id="participantSearch" 
                            placeholder="Enter name, email, or phone..."
                            onkeyup="searchParticipants()"
                        >
                        <div id="searchResults" class="search-results"></div>
                    </div>

                    <!-- Manual Input Form -->
                    <div class="manual-input-group">
                        <label>Participant ID:</label>
                        <input 
                            type="text" 
                            id="manualParticipantId" 
                            placeholder="Enter participant ID..."
                            readonly
                        >
                    </div>

                    <div class="manual-input-group">
                        <label>Participant Name:</label>
                        <input 
                            type="text" 
                            id="manualParticipantName" 
                            readonly
                        >
                    </div>

                    <div class="manual-input-group">
                        <label>College:</label>
                        <input 
                            type="text" 
                            id="manualCollege" 
                            readonly
                        >
                    </div>

                    <button 
                        onclick="markManualAttendance()" 
                        style="width:100%; padding:12px; background:#4CAF50; color:white; border:none; border-radius:5px; cursor:pointer;"
                    >
                        Mark Attendance Manually
                    </button>
                    
                    <div id="manualResult" style="margin-top:10px;"></div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="stats-tab" class="tab-content">
                <div style="background:#f5f5f5; padding:15px; border-radius:5px;">
                    <h3>Attendance Statistics</h3>
                    <p>Total Registered: <span id="totalRegistered">0</span></p>
                    <p>Present: <span id="presentCount">0</span></p>
                    <p>Absent: <span id="absentCount">0</span></p>
                    <p>Attendance %: <span id="attendancePercent">0%</span></p>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDE -->
        <div>
            <h3>All Registrations</h3>

            <input
                id="searchBox"
                placeholder="Search by Name / ID / College..."
                style="width:70%; padding:8px;"
                onkeyup="filterRegistrations()"
            >
            <button onclick="refreshRegistrations()">Refresh</button>

            <div id="registrationsContainer" style="margin-top:15px;"></div>
        </div>
    </div>
</div>

<script>
const BASE_URL = 'https://threads26-2-fdem.onrender.com';
let token = localStorage.getItem('coordinatorToken');
let eventId = localStorage.getItem('currentEventId');
let eventName = localStorage.getItem('currentEventName');

let allRegistrations = [];
let html5QrCode;
let scanning = false;
let searchTimeout;

/* ---------------- INIT ---------------- */
window.onload = () => {
    if (!token || !eventId) {
        alert('Login required');
        window.close();
        return;
    }
    document.getElementById('eventTitle').textContent =
        `${eventName} - Attendance Portal`;
    loadEventRegistrations();
    startScanner();
};

/* ---------------- TAB MANAGEMENT ---------------- */
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.add('active');
    document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
    
    // Stop scanner when switching away from QR tab
    if (tabName !== 'qr') {
        stopScanner();
    } else {
        startScanner();
    }
}

/* ---------------- QR SCANNER ---------------- */
function startScanner() {
    if (scanning) return;

    html5QrCode = new Html5Qrcode("reader");
    scanning = true;

    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        () => {}
    ).catch(() => scanning = false);
}

function stopScanner() {
    if (html5QrCode && scanning) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            scanning = false;
        });
    }
}

async function onScanSuccess(decodedText) {
    stopScanner();
    const scanDiv = document.getElementById('scanResult');
    scanDiv.innerHTML = '';

    let scannedIds = [];

    try {
        const qrData = JSON.parse(decodedText);
        scannedIds = qrData.registration_ids || [];
    } catch {
        scannedIds = decodedText
            .split(/[\n, ]+/)
            .map(x => x.trim())
            .filter(Boolean);
    }

    // Debug logging
    console.log('Scanned text:', decodedText);
    console.log('Parsed IDs:', scannedIds);
    console.log('Current Event ID:', eventId);

    // ✅ FIXED: Better validation for registration IDs
    const validIds = scannedIds.filter(id => {
        try {
            // Check if it's a Threads26 ID
            const isThreadsId = id.startsWith('THREADS26-');
            
            if (!isThreadsId) return false;
            
            // Extract event ID from registration_unique_id format
            // Format examples:
            // - THREADS26-SONA-123-1 (SONACSE student for event 1)
            // - THREADS26-OTHER-456-12 (Other college for event 12)
            const parts = id.split('-');
            
            if (parts.length < 4) return false;
            
            const extractedEventId = parts[parts.length - 1];
            
            // Validate numeric event ID
            if (!/^\d+$/.test(extractedEventId)) return false;
            
            return extractedEventId === String(eventId);
            
        } catch (error) {
            console.log('Error parsing ID:', id, error);
            return false;
        }
    });

    console.log('Valid IDs:', validIds);

    if (validIds.length === 0) {
        scanDiv.innerHTML = '<p style="color:red">❌ Invalid QR (Event mismatch or invalid format)</p>';
        setTimeout(startScanner, 1500);
        return;
    }

    for (let id of validIds) {
        const res = await fetch(`${BASE_URL}/api/scan-attendance`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ registration_id: id })
        });

        const data = await res.json();
        const p = document.createElement('p');

        if (data.success) {
            p.style.color = 'green';
            p.textContent = `✅ ${id} - ${data.message}`;
            if (data.participant) {
                p.textContent += ` (${data.participant.full_name})`;
            }
            const r = allRegistrations.find(x => x.registration_unique_id === id);
            if (r) {
                r.attendance_status = 'ATTENDED';
                r.verification_status = data.payment_info?.admin_verified ? 'Verified' : 'Pending';
            }
        } else {
            p.style.color = 'red';
            p.textContent = `❌ ${id} - ${data.message}`;
            // Show backend error details
            if (data.details) {
                const details = document.createElement('div');
                details.style.fontSize = '0.8em';
                details.style.color = 'orange';
                details.textContent = `Reason: ${data.details}`;
                p.appendChild(details);
            }
            if (data.suggestion) {
                const suggestion = document.createElement('div');
                suggestion.style.fontSize = '0.8em';
                suggestion.style.color = 'blue';
                suggestion.textContent = `Suggestion: ${data.suggestion}`;
                p.appendChild(suggestion);
            }
        }

        scanDiv.appendChild(p);
    }

    updateStats();
    filterRegistrations();

    setTimeout(() => {
        scanDiv.innerHTML = '';
        startScanner();
    }, 3000);
}

/* ---------------- MANUAL ATTENDANCE ---------------- */
async function searchParticipants() {
    clearTimeout(searchTimeout);
    const searchTerm = document.getElementById('participantSearch').value.trim();
    
    if (searchTerm.length < 2) {
        document.getElementById('searchResults').innerHTML = '';
        return;
    }
    
    searchTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`${BASE_URL}/api/search-participants?search=${encodeURIComponent(searchTerm)}&event_id=${eventId}`);
            const data = await res.json();
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '';
            
            if (!data.success || data.count === 0) {
                resultsDiv.innerHTML = '<div style="padding:10px; color:#666;">No participants found</div>';
                return;
            }
            
            data.participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `
                    <strong>${participant.full_name}</strong><br>
                    <small>${participant.email} | ${participant.college_name}</small><br>
                    <small>Event: ${participant.event_name} | Status: ${participant.attendance_status || 'PENDING'}</small>
                `;
                div.onclick = () => selectParticipant(participant);
                resultsDiv.appendChild(div);
            });
        } catch (error) {
            console.error('Search error:', error);
        }
    }, 300);
}

function selectParticipant(participant) {
    // Set the selected participant
    document.getElementById('manualParticipantId').value = participant.participant_id;
    document.getElementById('manualParticipantName').value = participant.full_name;
    document.getElementById('manualCollege').value = participant.college_name;
    
    // Highlight selected item
    document.querySelectorAll('.search-result-item').forEach(item => {
        item.classList.remove('selected');
    });
    event.target.closest('.search-result-item').classList.add('selected');
    
    // Clear search results
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('participantSearch').value = participant.full_name;
}

async function markManualAttendance() {
    const participantId = document.getElementById('manualParticipantId').value;
    const resultDiv = document.getElementById('manualResult');
    
    if (!participantId) {
        resultDiv.innerHTML = '<p style="color:red">Please select a participant first</p>';
        return;
    }
    
    resultDiv.innerHTML = '<p style="color:blue">Marking attendance...</p>';
    
    try {
        const res = await fetch(`${BASE_URL}/api/manual-attendance`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                participant_id: participantId,
                event_id: eventId
            })
        });
        
        const data = await res.json();
        
        if (data.success) {
            resultDiv.innerHTML = `<p style="color:green">✅ ${data.message}</p>`;
            
            // Update the registration in our list
            const r = allRegistrations.find(x => x.participant_id === participantId && x.event_id == eventId);
            if (r) {
                r.attendance_status = 'ATTENDED';
                r.verification_status = data.payment_info?.admin_verified ? 'Verified' : 'Pending';
            }
            
            updateStats();
            filterRegistrations();
            
            // Clear form
            document.getElementById('manualParticipantId').value = '';
            document.getElementById('manualParticipantName').value = '';
            document.getElementById('manualCollege').value = '';
            document.getElementById('participantSearch').value = '';
            
        } else {
            resultDiv.innerHTML = `<p style="color:red">❌ ${data.message}</p>`;
            if (data.details) {
                resultDiv.innerHTML += `<p style="color:orange">Details: ${data.details}</p>`;
            }
            if (data.suggestion) {
                resultDiv.innerHTML += `<p style="color:blue">Suggestion: ${data.suggestion}</p>`;
            }
        }
    } catch (error) {
        console.error('Manual attendance error:', error);
        resultDiv.innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
    }
}

/* ---------------- DATA MANAGEMENT ---------------- */
async function loadEventRegistrations() {
    try {
        const res = await fetch(
            `${BASE_URL}/api/admin/registrations?event_id=${eventId}`,
            { headers: { 'x-admin-token': token } }
        );
        
        if (!res.ok) {
            throw new Error(`Failed to load registrations: ${res.status}`);
        }
        
        allRegistrations = await res.json();
        displayRegistrations(allRegistrations);
        updateStats();
    } catch (error) {
        console.error('Error loading registrations:', error);
        alert('Failed to load registrations. Please try again.');
    }
}

function displayRegistrations(list) {
    if (list.length === 0) {
        document.getElementById('registrationsContainer').innerHTML = 
            '<p style="color:#666; text-align:center;">No registrations found for this event.</p>';
        return;
    }

    let html = `<table border="1" cellpadding="8" width="100%" style="border-collapse:collapse;">
        <thead style="background-color:#f2f2f2;">
        <tr>
            <th>Name</th>
            <th>Participant ID</th>
            <th>Registration ID</th>
            <th>College</th>
            <th>Event Type</th>
            <th>Payment Status</th>
            <th>Admin Verified</th>
            <th>Attendance</th>
        </tr>
        </thead>
        <tbody>`;

    list.forEach(r => {
        const isPresent = r.attendance_status === 'ATTENDED';
        html += `<tr style="${isPresent ? 'background-color: #d4edda;' : 'background-color: #fff;'}">
            <td><strong>${r.full_name || 'N/A'}</strong></td>
            <td><small style="font-family:monospace;">${r.participant_id || 'N/A'}</small></td>
            <td><small style="font-family:monospace;">${r.registration_unique_id || 'N/A'}</small></td>
            <td>${r.college_name || 'N/A'}</td>
            <td>${r.event_type || 'N/A'}</td>
            <td>
                <span style="padding:2px 8px; border-radius:3px; 
                    background-color:${r.payment_status === 'Success' ? '#d4edda' : 
                                     r.payment_status === 'Pending' ? '#fff3cd' : 
                                     r.payment_status === 'Failed' ? '#f8d7da' : '#f2f2f2'};">
                    ${r.payment_status || 'N/A'}
                </span>
            </td>
            <td>
                <span style="padding:2px 8px; border-radius:3px; 
                    background-color:${r.verification_status === 'Verified' ? '#d4edda' : '#fff3cd'};">
                    ${r.verification_status || 'Pending'}
                </span>
            </td>
            <td>
                <strong style="color:${isPresent ? '#155724' : '#721c24'};">
                    ${r.attendance_status || 'PENDING'}
                </strong>
            </td>
        </tr>`;
    });

    html += '</tbody></table>';
    document.getElementById('registrationsContainer').innerHTML = html;
}

function updateStats() {
    const total = allRegistrations.length;
    const present = allRegistrations.filter(r => r.attendance_status === 'ATTENDED').length;
    const absent = total - present;
    
    document.getElementById('totalRegistered').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    
    const percent = total ? ((present / total) * 100).toFixed(1) : 0;
    document.getElementById('attendancePercent').textContent = `${percent}%`;
    
    // Update color based on attendance percentage
    const percentSpan = document.getElementById('attendancePercent');
    percentSpan.style.color = percent >= 80 ? '#155724' : 
                              percent >= 50 ? '#856404' : '#721c24';
}

/* ---------------- SEARCH ---------------- */
function filterRegistrations() {
    const q = document.getElementById('searchBox').value.toLowerCase().trim();

    if (!q) {
        displayRegistrations(allRegistrations);
        return;
    }

    const filtered = allRegistrations.filter(r =>
        (r.full_name && r.full_name.toLowerCase().includes(q)) ||
        (r.participant_id && r.participant_id.toString().includes(q)) ||
        (r.registration_unique_id && r.registration_unique_id.toLowerCase().includes(q)) ||
        (r.college_name && r.college_name.toLowerCase().includes(q)) ||
        (r.email && r.email.toLowerCase().includes(q))
    );

    displayRegistrations(filtered);
}

/* ---------------- UTIL ---------------- */
function refreshRegistrations() {
    const searchBox = document.getElementById('searchBox');
    searchBox.value = ''; // Clear search on refresh
    loadEventRegistrations();
}

// Handle page close/refresh
window.addEventListener('beforeunload', () => {
    if (scanning) {
        stopScanner();
    }
});

</script>

</body>
</html>
