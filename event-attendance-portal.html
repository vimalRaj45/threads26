<!DOCTYPE html>
<html>
<head>
    <title>Event Attendance Portal</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #portal {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            opacity: 0.9;
        }
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 70%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status-attended {
            color: green;
            font-weight: bold;
        }
        .status-pending {
            color: orange;
            font-weight: bold;
        }
        #reader {
            width: 100%;
            margin: 15px 0;
        }
        #scanResult {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .success-msg {
            color: green;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 5px;
        }
        .error-msg {
            color: #dc2626;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 5px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>

<div id="portal">
    <!-- Header -->
    <div class="header">
        <h1 id="eventTitle">Event Attendance Portal</h1>
        <button onclick="window.close()">Close Portal</button>
    </div>

    <div class="grid-container">
        <!-- LEFT SIDE - Scanner & Stats -->
        <div>
            <!-- QR Scanner Card -->
            <div class="card">
                <h3><i class="fas fa-qrcode"></i> QR Code Scanner</h3>
                <div id="reader"></div>
                <div style="margin-top:15px; display: flex; gap:10px;">
                    <button onclick="startScanner()" id="startBtn">Start Scanner</button>
                    <button onclick="stopScanner()" id="stopBtn" style="background:#dc2626;">Stop Scanner</button>
                </div>
                <div id="scanResult"></div>
                <div style="margin-top:15px; font-size:12px; color:#666;">
                    <p><i class="fas fa-info-circle"></i> Instructions:</p>
                    <ul style="margin-left: 20px;">
                        <li>Point camera at participant's QR code</li>
                        <li>Scanner will automatically mark attendance</li>
                        <li>Only valid event QR codes will be accepted</li>
                    </ul>
                </div>
            </div>

            <!-- Stats Card -->
            <div class="card" style="margin-top:20px;">
                <h3><i class="fas fa-chart-bar"></i> Attendance Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="totalRegistered">0</div>
                        <div class="stat-label">Total Registered</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="presentCount">0</div>
                        <div class="stat-label">Present</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="absentCount">0</div>
                        <div class="stat-label">Absent</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="attendancePercent">0%</div>
                        <div class="stat-label">Attendance %</div>
                    </div>
                </div>
                <div style="margin-top:15px; text-align:center;">
                    <button onclick="refreshRegistrations()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT SIDE - Registrations List -->
        <div>
            <div class="card">
                <h3><i class="fas fa-list"></i> All Registrations</h3>
                
                <!-- Search and Filter -->
                <div style="display: flex; gap:10px; margin-bottom:20px;">
                    <input 
                        id="searchBox" 
                        placeholder="Search by Name, ID, College, or Department..."
                        onkeyup="filterRegistrations()"
                    >
                    <select id="statusFilter" onchange="filterRegistrations()" style="padding:10px; border:1px solid #ddd; border-radius:5px;">
                        <option value="">All Status</option>
                        <option value="ATTENDED">Attended</option>
                        <option value="PENDING">Pending</option>
                    </select>
                </div>

                <!-- Registrations Table -->
                <div id="registrationsContainer">
                    <div style="text-align:center; padding:40px; color:#666;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p>Loading registrations...</p>
                    </div>
                </div>

                <!-- Manual Attendance Marking -->
                <div style="margin-top:20px; padding:20px; background:#f8f9fa; border-radius:8px;">
                    <h4><i class="fas fa-edit"></i> Manual Attendance</h4>
                    <div style="display: flex; gap:10px; margin-top:10px;">
                        <input 
                            id="manualRegistrationId" 
                            placeholder="Enter Registration ID"
                            style="flex:1;"
                        >
                        <button onclick="markAttendanceManually()">Mark Attendance</button>
                    </div>
                    <div id="manualResult" style="margin-top:10px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const BASE_URL = 'https://threads26-2-fdem.onrender.com'; // Change to your backend URL
let token = localStorage.getItem('coordinatorToken');
let eventId = localStorage.getItem('currentEventId');
let eventName = localStorage.getItem('currentEventName');

let allRegistrations = [];
let html5QrCode;
let scanning = false;

// Font Awesome icons
const faIcons = `
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
`;
document.head.insertAdjacentHTML('beforeend', faIcons);

/* ---------------- INITIALIZATION ---------------- */
window.onload = async () => {
    if (!token || !eventId) {
        alert('Login required. Please log in as coordinator.');
        window.close();
        return;
    }
    
    document.getElementById('eventTitle').textContent = `${eventName} - Attendance Portal`;
    await loadEventRegistrations();
    startScanner();
    
    // Update scanner button states
    document.getElementById('stopBtn').disabled = true;
};

/* ---------------- QR SCANNER FUNCTIONS ---------------- */
function startScanner() {
    if (scanning) return;
    
    html5QrCode = new Html5Qrcode("reader");
    scanning = true;
    
    // Update button states
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    
    html5QrCode.start(
        { facingMode: "environment" },
        { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0
        },
        onScanSuccess,
        () => {}
    ).catch(err => {
        console.error("Scanner error:", err);
        scanning = false;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('scanResult').innerHTML = 
            '<div class="error-msg"><i class="fas fa-exclamation-triangle"></i> Scanner failed to start. Check camera permissions.</div>';
    });
}

function stopScanner() {
    if (html5QrCode && scanning) {
        html5QrCode.stop().then(() => {
            html5QrCode.clear();
            scanning = false;
            
            // Update button states
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }).catch(err => {
            console.error("Stop scanner error:", err);
        });
    }
}

async function onScanSuccess(decodedText) {
    stopScanner();
    const scanDiv = document.getElementById('scanResult');
    scanDiv.innerHTML = '';
    
    try {
        // Try to parse as JSON
        let registrationIds = [];
        try {
            const qrData = JSON.parse(decodedText);
            registrationIds = qrData.registration_ids || [];
        } catch {
            // If not JSON, try comma/space separated
            registrationIds = decodedText
                .split(/[\n, ]+/)
                .map(x => x.trim())
                .filter(Boolean);
        }
        
        if (registrationIds.length === 0) {
            scanDiv.innerHTML = '<div class="error-msg"><i class="fas fa-times"></i> No valid registration IDs found</div>';
            setTimeout(startScanner, 2000);
            return;
        }
        
        // Process each registration ID
        let successCount = 0;
        let errorCount = 0;
        
        for (let regId of registrationIds) {
            try {
                const response = await fetch(`${BASE_URL}/api/scan-attendance`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ registration_id: regId })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Update local registration status
                    const regIndex = allRegistrations.findIndex(r => r.registration_unique_id === regId);
                    if (regIndex !== -1) {
                        allRegistrations[regIndex].attendance_status = 'ATTENDED';
                        allRegistrations[regIndex].attended_at = new Date().toISOString();
                    }
                    
                    successCount++;
                    
                    // Display success message
                    const successMsg = document.createElement('div');
                    successMsg.className = 'success-msg';
                    successMsg.innerHTML = `<i class="fas fa-check"></i> ${regId}: ${data.message || 'Attendance marked'}`;
                    scanDiv.appendChild(successMsg);
                } else {
                    errorCount++;
                    
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'error-msg';
                    errorMsg.innerHTML = `<i class="fas fa-times"></i> ${regId}: ${data.message || 'Failed to mark attendance'}`;
                    scanDiv.appendChild(errorMsg);
                }
            } catch (error) {
                errorCount++;
                console.error(`Error processing ${regId}:`, error);
            }
        }
        
        // Update display and stats
        filterRegistrations();
        updateStats();
        
        // Show summary
        const summary = document.createElement('div');
        summary.style.marginTop = '10px';
        summary.style.padding = '10px';
        summary.style.backgroundColor = '#f8f9fa';
        summary.style.borderRadius = '5px';
        summary.innerHTML = `<strong>Summary:</strong> ${successCount} successful, ${errorCount} failed`;
        scanDiv.appendChild(summary);
        
        // Restart scanner after delay
        setTimeout(startScanner, 3000);
        
    } catch (error) {
        console.error('Scan processing error:', error);
        scanDiv.innerHTML = '<div class="error-msg"><i class="fas fa-exclamation-triangle"></i> Error processing QR code</div>';
        setTimeout(startScanner, 2000);
    }
}

/* ---------------- DATA FUNCTIONS ---------------- */
async function loadEventRegistrations() {
    try {
        const response = await fetch(
            `${BASE_URL}/api/admin/registrations?event_id=${eventId}`,
            { 
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            }
        );
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        allRegistrations = await response.json();
        displayRegistrations(allRegistrations);
        updateStats();
    } catch (error) {
        console.error('Error loading registrations:', error);
        document.getElementById('registrationsContainer').innerHTML = 
            `<div class="error-msg">
                <i class="fas fa-exclamation-triangle"></i> Failed to load registrations: ${error.message}
            </div>`;
    }
}

function displayRegistrations(list) {
    if (!list || list.length === 0) {
        document.getElementById('registrationsContainer').innerHTML = 
            '<div style="text-align:center; padding:40px; color:#666;">No registrations found for this event.</div>';
        return;
    }
    
    let html = `
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Registration ID</th>
                        <th>College</th>
                        <th>Department</th>
                        <th>Payment Status</th>
                        <th>Admin Verified</th>
                        <th>Attendance Status</th>
                        <th>Scanned At</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    list.forEach((r, index) => {
        const attended = r.attendance_status === 'ATTENDED';
        const paymentStatus = r.payment_status || 'PENDING';
        const adminVerified = r.verified_by_admin ? 'Yes' : 'No';
        
        html += `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${r.full_name || 'N/A'}</strong></td>
                <td><code>${r.registration_unique_id || 'N/A'}</code></td>
                <td>${r.college_name || 'N/A'}</td>
                <td>${r.department || 'N/A'}</td>
                <td class="${paymentStatus === 'Success' ? 'status-attended' : 'status-pending'}">
                    ${paymentStatus}
                </td>
                <td>${adminVerified}</td>
                <td class="${attended ? 'status-attended' : 'status-pending'}">
                    ${attended ? '<i class="fas fa-check-circle"></i> ATTENDED' : 'PENDING'}
                </td>
                <td>${r.attended_at ? new Date(r.attended_at).toLocaleString() : 'Not scanned'}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div style="margin-top:10px; color:#666; font-size:12px;">
            Showing ${list.length} of ${allRegistrations.length} registrations
        </div>
    `;
    
    document.getElementById('registrationsContainer').innerHTML = html;
}

function updateStats() {
    const total = allRegistrations.length;
    const present = allRegistrations.filter(r => r.attendance_status === 'ATTENDED').length;
    const absent = total - present;
    const percent = total > 0 ? ((present / total) * 100).toFixed(1) : 0;
    
    document.getElementById('totalRegistered').textContent = total;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('attendancePercent').textContent = `${percent}%`;
}

function filterRegistrations() {
    const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
    const statusFilter = document.getElementById('statusFilter').value;
    
    let filtered = allRegistrations;
    
    // Apply search filter
    if (searchTerm) {
        filtered = filtered.filter(r => 
            (r.full_name && r.full_name.toLowerCase().includes(searchTerm)) ||
            (r.registration_unique_id && r.registration_unique_id.toLowerCase().includes(searchTerm)) ||
            (r.college_name && r.college_name.toLowerCase().includes(searchTerm)) ||
            (r.department && r.department.toLowerCase().includes(searchTerm))
        );
    }
    
    // Apply status filter
    if (statusFilter) {
        filtered = filtered.filter(r => r.attendance_status === statusFilter);
    }
    
    displayRegistrations(filtered);
}

/* ---------------- MANUAL ATTENDANCE MARKING ---------------- */
async function markAttendanceManually() {
    const manualId = document.getElementById('manualRegistrationId').value.trim();
    const resultDiv = document.getElementById('manualResult');
    
    if (!manualId) {
        resultDiv.innerHTML = '<div class="error-msg">Please enter a Registration ID</div>';
        return;
    }
    
    resultDiv.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> Processing...</div>';
    
    try {
        const response = await fetch(`${BASE_URL}/api/scan-attendance`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ registration_id: manualId })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            resultDiv.innerHTML = `<div class="success-msg">
                <i class="fas fa-check"></i> Attendance marked successfully!
                <p style="margin-top:5px; font-size:12px;">${data.message}</p>
            </div>`;
            
            // Update local data
            await loadEventRegistrations();
        } else {
            resultDiv.innerHTML = `<div class="error-msg">
                <i class="fas fa-times"></i> Failed: ${data.message || 'Unknown error'}
            </div>`;
        }
    } catch (error) {
        console.error('Manual attendance error:', error);
        resultDiv.innerHTML = `<div class="error-msg">
            <i class="fas fa-exclamation-triangle"></i> Network error: ${error.message}
        </div>`;
    }
}

/* ---------------- UTILITY FUNCTIONS ---------------- */
function refreshRegistrations() {
    loadEventRegistrations();
    document.getElementById('scanResult').innerHTML = '';
}

// Clean up scanner on page unload
window.addEventListener('beforeunload', () => {
    if (html5QrCode && scanning) {
        html5QrCode.stop().catch(console.error);
    }
});
</script>

</body>
</html>
